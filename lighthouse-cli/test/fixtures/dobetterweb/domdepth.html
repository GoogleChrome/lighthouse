<!doctype html>
<!--
 * Copyright 2017 Google Inc. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
-->
<html>
<head>
  <title>DoBetterWeb - DOM size tester</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
</head>
<body>
  <main>
    <section>
      <div>
        <div>6</div>
      </div>
      <div>
        <div>
          <div id="attachshadow">7</div>
        </div>
      </div>
      <div>
        <template>
          <div><div><div><div>10, but noop in template</div></div></div></div>
        </template>
      </div>
    </section>
  </main>
  <footer>
    <div id="attachshadow-big" class="test this out">4</div>
    <div>3</div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
  </footer>
<script>
  function createSelectorsLabel(element) {
    let name = element.localName;
    const idAttr = element.getAttribute('id');
    if (idAttr) {
      name += `#${idAttr}`;
    }
    const className = element.className;
    if (className) {
      name += `.${className.split(' ').join('.')}`;
    }
    return name;
  }

  /**
  * @param {!HTMLElement} element
  * @return {!Array<string>}
  */
  function elementPathInDOM(element) {
    const path = [createSelectorsLabel(element)];
    let node = element;
    while (node) {
      node = node.parentNode.host ? node.parentNode.host : node.parentElement;
      if (node) {
        path.push(createSelectorsLabel(node));
      }
    }
    return path.reverse();
  }

  /**
   * Calculates the maximum tree depth of the DOM.
   * @param {!HTMLElement} element Root of the tree to look in.
   * @param {boolean=} deep True to include shadow roots. Defaults to true.
   * @return {!number}
   */
  function getDOMStats(element, deep=true) {
    let deepestNode = null;
    let maxDepth = 0;
    let maxWidth = 0;
    let parentWithMostChildren = null;

    const _calcDOMWidthAndHeight = function(element, depth=1) {
      if (depth > maxDepth) {
        deepestNode = element;
        maxDepth = depth;
      }
      if (element.children.length > maxWidth) {
        parentWithMostChildren = element;
        maxWidth = element.children.length;
      }

      let child = element.firstElementChild;
      while (child) {
        _calcDOMWidthAndHeight(child, depth + 1);
        // If node has shadow dom, traverse into that tree.
        if (deep && child.shadowRoot) {
          _calcDOMWidthAndHeight(child.shadowRoot, depth + 1);
        }
        child = child.nextElementSibling;
      }

      return {maxDepth, maxWidth};
    };

    const result = _calcDOMWidthAndHeight(element);

    return {
      depth: {
        max: result.maxDepth,
        pathToElement: elementPathInDOM(deepestNode),
      },
      width: {
        max: result.maxWidth,
        pathToElement: elementPathInDOM(parentWithMostChildren)
      }
    };
  }

  const el = document.querySelector('#attachshadow');
  el.innerHTML = `<div>7</div>`;
  el.attachShadow({mode: 'open'}).innerHTML = `
    <div>
      <div class="here">9</div>
    </div>
  `;

  const el2 = document.querySelector('#attachshadow-big');
  // el2.innerHTML = `<div><div><div><div><div><div><div><div>12</div></div></div></div></div></div></div></div>`;
  el2.attachShadow({mode: 'open'}).innerHTML = `
    <div>
      <div>6</div>
      <div>6</div>
      <div>6</div>
      <div>6</div>
      <div>6</div>
      <div>6</div>
      <div>6</div>
      <div>6</div>
      <div>6</div>
    </div>
  `;

  function addDOMTest() {
    const frag = new DocumentFragment();
    const NUM_NODES = 2020;
    for (let i = 0; i < NUM_NODES; ++i) {
      frag.appendChild(document.createElement('span'));
    }
    document.body.appendChild(frag);
  }

  const params = new URLSearchParams(location.search);
  if (location.search === '') {
    addDOMTest();
  } else {
    if (params.has('documentWrite')) {
      addDOMTest();
    }
  }

  // const result = getDOMStats(document.documentElement);
  // console.assert(result.depth.max === 9);
  // console.assert(result.width.max === 9);
</script>
</body>
</html>